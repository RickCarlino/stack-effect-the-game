<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Stack Effect: The Game</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com/" />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.co
      /"
      crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap"
      rel="stylesheet" />
    <style>
      /* devanagari */
      @font-face {
        font-family: "Baloo 2";
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/baloo2/v21/wXKrE3kTposypRyd51ncANwr.woff2)
          format("woff2");
        unicode-range: U+0900-097F, U+1CD0-1CF9, U+200C-200D, U+20A8, U+20B9,
          U+20F0, U+25CC, U+A830-A839, U+A8E0-A8FF, U+11B00-11B09;
      }
      /* vietnamese */
      @font-face {
        font-family: "Baloo 2";
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/baloo2/v21/wXKrE3kTposypRyd51fcANwr.woff2)
          format("woff2");
        unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169,
          U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309,
          U+0323, U+0329, U+1EA0-1EF9, U+20AB;
      }
      /* latin-ext */
      @font-face {
        font-family: "Baloo 2";
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/baloo2/v21/wXKrE3kTposypRyd51bcANwr.woff2)
          format("woff2");
        unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7,
          U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F,
          U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F,
          U+A720-A7FF;
      }
      /* latin */
      @font-face {
        font-family: "Baloo 2";
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/baloo2/v21/wXKrE3kTposypRyd51jcAA.woff2)
          format("woff2");
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6,
          U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122,
          U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
      /* devanagari */
      @font-face {
        font-family: "Baloo 2";
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/baloo2/v21/wXKrE3kTposypRyd51ncANwr.woff2)
          format("woff2");
        unicode-range: U+0900-097F, U+1CD0-1CF9, U+200C-200D, U+20A8, U+20B9,
          U+20F0, U+25CC, U+A830-A839, U+A8E0-A8FF, U+11B00-11B09;
      }
      /* vietnamese */
      @font-face {
        font-family: "Baloo 2";
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/baloo2/v21/wXKrE3kTposypRyd51fcANwr.woff2)
          format("woff2");
        unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169,
          U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309,
          U+0323, U+0329, U+1EA0-1EF9, U+20AB;
      }
      /* latin-ext */
      @font-face {
        font-family: "Baloo 2";
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/baloo2/v21/wXKrE3kTposypRyd51bcANwr.woff2)
          format("woff2");
        unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7,
          U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F,
          U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F,
          U+A720-A7FF;
      }
      /* latin */
      @font-face {
        font-family: "Baloo 2";
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url(https://fonts.gstatic.com/s/baloo2/v21/wXKrE3kTposypRyd51jcAA.woff2)
          format("woff2");
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6,
          U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122,
          U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }

      body {
        font-family: "Baloo 2", cursive, sans-serif;
        margin: 20px;
        text-align: center;
        background: #ffeafc;
        color: #333;
      }
      h1 {
        margin-bottom: 0.5em;
        color: #c71585;
        text-shadow: 1px 1px #fff;
      }
      .hand {
        border: 2px dashed #ff6ec7;
        display: inline-block;
        padding: 1em;
        margin-bottom: 1em;
        background-color: #fff0fa;
        border-radius: 10px;
        min-width: 120px;
      }
      .top-of-hand {
        font-size: 2.5em;
        margin-top: 0.5em;
      }
      #turn-counter {
        font-weight: bold;
        margin-bottom: 1em;
        font-size: 1.1em;
      }
      #guess-section {
        margin-top: 2em;
      }
      #message {
        margin-top: 1em;
        font-weight: bold;
        color: #c71585;
      }
      #emoji-keypad {
        margin: 1em 0;
      }
      .emoji-button {
        font-size: 1.5em;
        margin: 0 0.3em;
        padding: 0.4em 0.6em;
        border: 2px solid #ff6ec7;
        background: #fff;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
      }
      .emoji-button:hover {
        background: #ffeafc;
        transform: scale(1.1);
      }
      .game-button {
        font-size: 1em;
        padding: 0.5em 1em;
        cursor: pointer;
        background: #fff;
        border: 2px solid #c71585;
        border-radius: 10px;
        transition: background 0.2s, transform 0.2s;
        margin: 0.5em; /* Added margin for spacing */
      }
      .game-button:hover {
        background: #ffeafc;
        transform: scale(1.05);
      }
      .delete-button {
        font-size: 1.5em;
        margin: 0 0.3em;
        padding: 0.4em 0.6em;
        border: 2px solid #ff6ec7;
        background: #fff;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
      }
      .delete-button:hover {
        background: #ffeafc;
        transform: scale(1.1);
      }
      #guess-input {
        font-family: "Baloo 2", cursive, sans-serif;
        font-size: 1.1em;
        padding: 0.6em 1em;
        border: 2px solid #ff6ec7;
        border-radius: 12px;
        background-color: #fff0fa;
        box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
        transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
        outline: none;
        width: 80%;
        max-width: 400px;
        margin-top: 0.5em;
      }
      #guess-input:focus {
        background-color: #ffeafc;
        transform: scale(1.02);
        box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.2);
      }
      #guess-section label {
        display: block;
        margin-bottom: 0.5em;
        font-size: 1.2em;
        color: #c71585;
      }
    </style>
  </head>
  <body>
    <h1>Stack Effect: The Game</h1>

    <p>
      Enhance your memory and understanding of Forth words. A random Forth card
      is added or manipulates your hand every 2 seconds.
    </p>
    <button
      id="start-button"
      class="game-button">
      Start Game
    </button>
    <button
      id="new-game-button"
      class="game-button">
      Reset
    </button>
    <div id="emoji-keypad">
      <p><strong>Emoji Keypad (Click to add to your guess):</strong></p>
      <button class="emoji-button">üíé</button>
      <button class="emoji-button">üåü</button>
      <button class="emoji-button">üçé</button>
      <button class="emoji-button">üçì</button>
      <button class="emoji-button">ü™ô</button>
      <button class="emoji-button">üß∏</button>
      <button class="emoji-button">üç¨</button>
      <button class="emoji-button">üç©</button>
      <button class="emoji-button">üéà</button>
      <button
        class="delete-button"
        title="Delete last emoji">
        üóëÔ∏è
      </button>
    </div>

    <div class="hand">
      <div><strong>Top of Hand</strong></div>
      <div
        id="top-of-hand"
        class="top-of-hand">
        Get ready...
      </div>
    </div>

    <div id="turn-counter">Turn: 0/8</div>

    <div id="guess-section">
      <div>
        <label for="guess-input"
          ><strong
            >Guess final hand (top to bottom, sequence of emojis):</strong
          ></label
        ><br />
        <input
          type="text"
          id="guess-input"
          size="50"
          placeholder="Example: üçìüß∏" />
      </div>
      <button
        id="guess-button"
        class="game-button">
        Submit Guess
      </button>
    </div>

    <div id="message"></div>
    <script>
      // --- Forth Dictionary and Helpers ---
      const literal = (value) => (stack) => {
        stack.push({ value });
        return stack;
      };

      const DICTIONARY = [
        { name: "üíé", before: 0, after: 1, execute: literal("üíé") },
        { name: "üåü", before: 0, after: 1, execute: literal("üåü") },
        { name: "üçé", before: 0, after: 1, execute: literal("üçé") },
        { name: "üçì", before: 0, after: 1, execute: literal("üçì") },
        { name: "ü™ô", before: 0, after: 1, execute: literal("ü™ô") },
        { name: "üß∏", before: 0, after: 1, execute: literal("üß∏") },
        { name: "üç¨", before: 0, after: 1, execute: literal("üç¨") },
        { name: "üç©", before: 0, after: 1, execute: literal("üç©") },
        { name: "üéà", before: 0, after: 1, execute: literal("üéà") },

        {
          name: "swap",
          before: 2,
          after: 2,
          execute(stack) {
            const item1 = stack.pop();
            const item2 = stack.pop();
            if (!item1 || !item2) throw new Error("Stack underflow - swap");
            stack.push(item1);
            stack.push(item2);
            return stack;
          },
        },
        {
          name: "dup",
          before: 1,
          after: 2,
          execute(stack) {
            const item = stack[stack.length - 1];
            if (!item) throw new Error("Stack underflow - dup");
            stack.push(item);
            return stack;
          },
        },
        {
          name: "drop",
          before: 1,
          after: 0,
          execute(stack) {
            if (!stack.pop()) throw new Error("Stack underflow - drop");
            return stack;
          },
        },
        {
          name: "over",
          before: 2,
          after: 3,
          execute(stack) {
            const item = stack[stack.length - 2];
            if (!item) throw new Error("Stack underflow - over");
            stack.push(item);
            return stack;
          },
        },
        {
          name: "rot",
          before: 3,
          after: 3,
          execute(stack) {
            const item3 = stack.splice(-3, 1)[0];
            if (!item3) throw new Error("Stack underflow - rot");
            stack.push(item3);
            return stack;
          },
        },
        {
          name: "-rot",
          before: 3,
          after: 3,
          execute(stack) {
            const item1 = stack.pop();
            if (!item1) throw new Error("Stack underflow - -rot");
            stack.splice(stack.length - 1, 0, item1);
            return stack;
          },
        },
        {
          name: "2dup",
          before: 2,
          after: 4,
          execute(stack) {
            const item1 = stack[stack.length - 2];
            const item2 = stack[stack.length - 1];
            if (!item1 || !item2) throw new Error("Stack underflow - 2dup");
            stack.push(item1);
            stack.push(item2);
            return stack;
          },
        },
        {
          name: "2drop",
          before: 2,
          after: 0,
          execute(stack) {
            if (!stack.pop() || !stack.pop())
              throw new Error("Stack underflow - 2drop");
            return stack;
          },
        },
        {
          name: "2swap",
          before: 4,
          after: 4,
          execute(stack) {
            const pair1 = stack.splice(-2, 2);
            const pair2 = stack.splice(-2, 2);
            if (pair1.length < 2 || pair2.length < 2) {
              throw new Error("Stack underflow - 2swap");
            }
            stack.push(...pair1);
            stack.push(...pair2);
            return stack;
          },
        },
        {
          name: "tuck",
          before: 2,
          after: 3,
          execute(stack) {
            const item1 = stack.pop();
            if (!item1) throw new Error("Stack underflow - tuck");
            stack.splice(stack.length - 2, 0, item1);
            return stack;
          },
        },
        {
          name: "nip",
          before: 2,
          after: 1,
          execute(stack) {
            if (!stack.pop() || !stack.pop())
              throw new Error("Stack underflow - nip");
            return stack;
          },
        },
        {
          name: "2over",
          before: 4,
          after: 6,
          execute(stack) {
            const pair1 = stack.slice(-4, -2);
            const pair2 = stack.slice(-2);
            if (pair1.length < 2 || pair2.length < 2) {
              throw new Error("Stack underflow - 2over");
            }
            stack.push(...pair1);
            stack.push(...pair2);
            return stack;
          },
        },
      ];

      // --- Game State ---
      let turn = 0;
      let stack = [];
      let lastMove = null;
      let gameInterval = null;

      const MAX_TURNS = 6;
      const MAX_STACK_DEPTH = 5;
      const TURN_INTERVAL = 2000;

      // --- DOM Elements ---
      const messageEl = document.getElementById("message");
      const topOfHandEl = document.getElementById("top-of-hand");
      const deleteBtn = document.querySelector(".delete-button");
      const guessInputEl = document.getElementById("guess-input");
      const turnCounterEl = document.getElementById("turn-counter");
      const guessButtonEl = document.getElementById("guess-button");
      const startButtonEl = document.getElementById("start-button");
      const newGameButtonEl = document.getElementById("new-game-button");

      // --- Setup Functions ---
      function clearGameState() {
        turn = 0;
        stack = [];
        lastMove = null;
        messageEl.textContent = "";
        guessInputEl.value = "";
      }

      function updateUI() {
        turnCounterEl.textContent = `Turn: ${turn}/${MAX_TURNS}`;
        topOfHandEl.textContent = lastMove ? lastMove.name : "Get ready...";
      }

      function getLegalMoves(currentStack) {
        return DICTIONARY.filter((word) => {
          const netEffect = word.after - word.before;
          const nextStackSize = currentStack.length + netEffect;
          return (
            word.before <= currentStack.length &&
            nextStackSize <= MAX_STACK_DEPTH
          );
        });
      }

      function randomMove() {
        const moves = getLegalMoves(stack);
        if (!moves.length) throw new Error("No legal moves available!");
        const index = Math.floor(Math.random() * moves.length);
        return moves[index];
      }

      function handleTurn() {
        turn++;
        if (turn > MAX_TURNS) {
          stopGame();
          messageEl.textContent = `${MAX_TURNS} turns complete! Enter your guess for the final hand.`;
          return;
        }

        const card = randomMove();
        card.execute(stack);
        lastMove = card;

        if (turn === MAX_TURNS) {
          stopGame();
          messageEl.textContent = `${MAX_TURNS} turns complete! Enter your guess for the final hand.`;
        }
        updateUI();
      }

      function startGame() {
        if (gameInterval) return; // Already running
        clearGameState();
        updateUI();
        handleTurn();
        gameInterval = setInterval(handleTurn, TURN_INTERVAL);
      }

      function stopGame() {
        clearInterval(gameInterval);
        gameInterval = null;
      }

      function handleGuess() {
        const guess = guessInputEl.value.trim();
        const guessItems = Array.from(guess);
        const actualTopToBottom = stack.map((item) => item.value);

        const isCorrect =
          guessItems.length === actualTopToBottom.length &&
          guessItems.every((g, i) => g === actualTopToBottom[i]);

        if (isCorrect) {
          clearGameState();
          messageEl.textContent = "Correct! You got it exactly right!";
        } else {
          messageEl.textContent = `Incorrect guess! Correct answer: ${actualTopToBottom.join(
            ""
          )}`;
        }
      }

      // --- Event Listeners ---
      startButtonEl.addEventListener("click", startGame);
      newGameButtonEl.addEventListener("click", window.location.reload);
      guessButtonEl.addEventListener("click", handleGuess);

      deleteBtn.addEventListener("click", () => {
        const currentGuess = guessInputEl.value.trim();
        if (!currentGuess) return;
        const guessItems = Array.from(currentGuess);
        guessItems.pop();
        guessInputEl.value = guessItems.join("");
      });

      // Add event to each literal emoji button in the original HTML
      // (We already have them in the DOM, just need to append their click logic.)
      Array.from(document.querySelectorAll(".emoji-button")).forEach((btn) => {
        btn.addEventListener("click", () => {
          guessInputEl.value += btn.textContent;
        });
      });

      // Initial UI update
      updateUI();
    </script>
  </body>
</html>
